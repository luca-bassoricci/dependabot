# ======================================================================================================================
# Global
# ======================================================================================================================
stages:
  - build
  - static analysis
  - unit test
  - e2e test
  - report
  - release
  - deploy
  # needed for templates to work
  - test

variables:
  CURRENT_TAG: ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}
  APP_IMAGE: ${CI_REGISTRY_IMAGE}:${CURRENT_TAG}
  BUILDKIT_IMAGE: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/moby/buildkit:v0.9.3
  DIND_IMAGE: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/docker:20.10.12-dind
  CI_IMAGE: registry.gitlab.com/dependabot-gitlab/dependabot/ci:latest
  CODACY_VERSION: "13.5.3"
  DEPENDENCY_SCANNING_DISABLED: "true"
  SAST_DISABLED: "true"
  CONTAINER_SCANNING_DISABLED: "true"
  CODE_QUALITY_DISABLED: "true"

include:
  - local: .gitlab/ci/jobs.gitlab-ci.yml
  - local: .gitlab/ci/rules.gitlab-ci.yml

# ======================================================================================================================
# Pre Stage
# ======================================================================================================================
cache-dependencies:
  extends:
    - .rules:main
    - .cache_dependencies

# ======================================================================================================================
# Build Stage
# ======================================================================================================================
build-app-image:
  extends:
    - .build_app_image
    - .rules:build-image

build-ci-image:
  extends:
    - .build_ci_image
    - .rules:build-ci-image

# ======================================================================================================================
# Static analysis stage
# ======================================================================================================================
rubocop:
  extends:
    - .rubocop
    - .rules:main
  needs:
    - cache-dependencies

reek:
  extends:
    - .reek
    - .rules:main
  needs:
    - cache-dependencies

brakeman:
  extends:
    - .brakeman
    - .rules:main
  needs:
    - cache-dependencies

bundle-audit:
  extends:
    - .bundle_audit
    - .rules:main
  needs:
    - cache-dependencies

dependency-scan:
  extends:
    - .dependency_scan
    - .rules:dependency-scan
  needs:
    - cache-dependencies

container-scan:
  extends:
    - .container_scanning
    - .rules:container-scan
  needs:
    - build-app-image

# ======================================================================================================================
# Unit Test Stage
# ======================================================================================================================
rspec:
  extends:
    - .rspec
    - .rules:main
  needs:
    - cache-dependencies

# ======================================================================================================================
# E2E Test Stage
# ======================================================================================================================
standalone:
  extends:
    - .standalone
    - .rules:main:e2e
  needs:
    - build-app-image

# ======================================================================================================================
# Reporting
# ======================================================================================================================
publish-allure-reports:
  extends:
    - .allure_report
    - .rules:allure-reports
  needs:
    - rspec

# ======================================================================================================================
# Release Stage
# ======================================================================================================================
release-image:
  extends:
    - .release_image
    - .rules:release
  dependencies: []

create-gitlab-release:
  extends:
    - .gitlab_release
    - .rules:release
  dependencies: []

update-helm-chart:
  extends:
    - .update_chart
    - .rules:release
  dependencies: []

update-standalone-repo:
  extends:
    - .update_standalone
    - .rules:release
  dependencies: []

# ======================================================================================================================
# Deploy Stage
# ======================================================================================================================
deploy:
  extends:
    - .deploy
    - .rules:deploy
