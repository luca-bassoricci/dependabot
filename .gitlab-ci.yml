# ======================================================================================================================
# Global
# ======================================================================================================================
stages:
  - build
  - static analysis
  - test
  - report
  - release
  - deploy
  - triage

variables:
  # App tags
  CURRENT_TAG: ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}
  # Docker images
  APP_IMAGE: ${CI_REGISTRY_IMAGE}/app:${CURRENT_TAG}
  BUILDKIT_IMAGE: moby/buildkit:v0.10.1
  DIND_IMAGE: docker:20.10.14-dind
  REDIS_IMAGE: bitnami/redis:6.2-debian-10
  MONGODB_IMAGE: bitnami/mongodb:4.4-debian-10
  MOCK_IMAGE: thiht/smocker:0.18.0
  ALLURE_IMAGE: andrcuns/allure-report-publisher:0.4.2
  CI_IMAGE: registry.gitlab.com/dependabot-gitlab/dependabot/ci:latest
  # Misc
  CODACY_VERSION: "13.5.3"
  DEPENDENCY_SCANNING_DISABLED: "true"
  SAST_DISABLED: "true"
  CONTAINER_SCANNING_DISABLED: "true"
  CODE_QUALITY_DISABLED: "true"

include:
  - local: .gitlab/ci/jobs.gitlab-ci.yml
  - local: .gitlab/ci/rules.gitlab-ci.yml

# ======================================================================================================================
# Pre Stage
# ======================================================================================================================
cache-dependencies:
  extends:
    - .rules:main
    - .cache_dependencies

# ======================================================================================================================
# Build Stage
# ======================================================================================================================
build-app-image:
  extends:
    - .build_app_image
    - .rules:build-image

build-ci-image:
  extends:
    - .build_ci_image
    - .rules:build-ci-image

# ======================================================================================================================
# Static analysis stage
# ======================================================================================================================
rubocop:
  extends:
    - .rubocop
    - .rules:main
  needs:
    - cache-dependencies

reek:
  extends:
    - .reek
    - .rules:main
  needs:
    - cache-dependencies

brakeman:
  extends:
    - .brakeman
    - .rules:main
  needs:
    - cache-dependencies

bundle-audit:
  extends:
    - .bundle_audit
    - .rules:main
  needs:
    - cache-dependencies

dependency-scan:
  extends:
    - .dependency_scan
    - .rules:dependency-scan
  needs:
    - cache-dependencies

container-scan:
  extends:
    - .container_scanning
    - .rules:container-scan
  needs:
    - build-app-image

# ======================================================================================================================
# Test Stage
# ======================================================================================================================
unit-test:
  extends:
    - .unit-test
    - .rules:main
  needs:
    - cache-dependencies

system-test:
  extends:
    - .system-test
    - .rules:main:system-test
  needs:
    - cache-dependencies

standalone-test:
  extends:
    - .standalone-test
    - .rules:main:standalone-test
  needs:
    - build-app-image

deploy-test:
  extends:
    - .deploy-test
    - .rules:main:deploy-test
  needs:
    - build-app-image

# ======================================================================================================================
# Reporting
# ======================================================================================================================
publish-allure-reports:
  extends:
    - .allure_report
    - .rules:allure-reports
  needs:
    - unit-test
    - system-test

publish-coverage:
  extends:
    - .coverage
    - .rules:coverage
  needs:
    - unit-test
    - system-test

# ======================================================================================================================
# Release Stage
# ======================================================================================================================
release-image:
  extends:
    - .release_image
    - .rules:release
  dependencies: []

create-gitlab-release:
  extends:
    - .gitlab_release
    - .rules:release
  dependencies: []

update-helm-chart:
  extends:
    - .update_chart
    - .rules:release
  dependencies: []

update-standalone-repo:
  extends:
    - .update_standalone
    - .rules:release
  dependencies: []

# ======================================================================================================================
# Deploy Stage
# ======================================================================================================================
deploy:
  extends:
    - .deploy
    - .rules:deploy

# ======================================================================================================================
# Scheduled jobs
# ======================================================================================================================
triage-issues:
  extends:
    - .triage_issues
    - .rules:triage-issues
