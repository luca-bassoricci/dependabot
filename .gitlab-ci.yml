include:
  - local: .gitlab/runners.yml

stages:
  - test
  - build
  - deploy

# ======================================================================================================================
# Pre Stage
# ======================================================================================================================
cache_gems:
  extends: .ruby_runner
  stage: .pre
  script:
    - bundle install
  cache:
    policy: push
  only:
    refs:
      - merge_request
      - master
    changes:
      - Gemfile.lock

# ======================================================================================================================
# Test Stage
# ======================================================================================================================
rubocop:
  extends: .ruby_runner
  stage: test
  script:
    - bundle exec rubocop --parallel --color
  only:
    - merge_request
    - master
    - tags

reek:
  extends: .ruby_runner
  stage: test
  script:
    - bundle exec reek --color --progress
  only:
    - merge_request
    - master
    - tags

rspec:
  extends: .ruby_runner
  stage: test
  variables:
    COVERAGE: "true"
    NO_COLOR: "1"
  script:
    - bundle exec rspec --format documentation --format RspecJunitFormatter --out tmp/rspec.xml
  coverage: /COVERAGE:\s+(\d+.\d+)\%/
  artifacts:
    reports:
      cobertura: coverage/coverage.xml
      junit: tmp/rspec.xml
  only:
    - merge_request
    - master
    - tags

# ======================================================================================================================
# Release Stage
# ======================================================================================================================
.build_docker_image: &build_docker_image
  - |
    docker build \
      --build-arg BUILDKIT_INLINE_CACHE=1 \
      --build-arg VERSION=$VERSION \
      --build-arg COMMIT_SHA=$CI_COMMIT_SHORT_SHA \
      --build-arg PROJECT_URL=$CI_PROJECT_URL \
      --cache-from $LATEST \
      --tag $IMAGE:$VERSION \
      --tag $LATEST \
      .

build:
  extends: .docker_runner
  stage: build
  variables:
    VERSION: $CI_COMMIT_SHORT_SHA
  script:
    - *build_docker_image
  only:
    refs:
      - master
      - merge_requests
    changes:
      - Dockerfile

release:
  extends: .docker_runner
  stage: build
  variables:
    VERSION: $CI_COMMIT_TAG
  script:
    - *build_docker_image
    - docker push $IMAGE:$VERSION
    - docker push $LATEST
  only:
    - tags

# ======================================================================================================================
# Deploy Stage
# ======================================================================================================================
deploy:
  image: finalgene/heroku-cli:7.42
  stage: deploy
  before_script:
    - apk add git
    - git fetch origin master && git checkout master
    - echo $NETRC > /root/.netrc
    - heroku git:remote -a dependabot-gitlab
  script:
    - git push heroku master
  environment:
    name: heroku
    url: https://dependabot-gitlab.herokuapp.com/
  only:
    refs:
      - master
    changes:
      - app/**/*
      - config/**/*
      - lib/**/*
      - public/**/*
      - config.ru
      - Gemfile
      - Gemfile.lock
      - Rakefile
      - Dockerfile
