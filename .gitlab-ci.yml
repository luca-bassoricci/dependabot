include:
  - local: .gitlab/runners.yml

stages:
  - static analysis
  - test
  - release
  - deploy

variables:
  APP_DOCKER_IMAGE: registry.gitlab.com/dependabot-gitlab/dependabot
  CURRENT_APP_IMAGE: $APP_DOCKER_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
  LATEST_APP_IMAGE: $APP_DOCKER_IMAGE:$CI_COMMIT_REF_SLUG-latest
  GITLAB_MOCK_DOCKER_IMAGE: registry.gitlab.com/dependabot-gitlab/dependabot/gitlab-mock
  CURRENT_GITLAB_MOCK_IMAGE: $GITLAB_MOCK_DOCKER_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
  LATEST_GITLAB_MOCK_IMAGE: $GITLAB_MOCK_DOCKER_IMAGE:$CI_COMMIT_REF_SLUG-latest

# ======================================================================================================================
# Pre Stage
# ======================================================================================================================
cache_gems:
  extends: .ruby_runner
  stage: .pre
  script:
    - bundle install
  cache:
    policy: pull-push
  only:
    refs:
      - merge_request
      - master
    changes:
      - Gemfile.lock

build_app:
  stage: .pre
  extends: .buildkit_runner
  script: |
    buildctl-daemonless.sh build \
      --frontend=dockerfile.v0 \
      --local context=. \
      --local dockerfile=. \
      --opt build-arg:COMMIT_SHA=$CI_COMMIT_SHA \
      --opt build-arg:PROJECT_URL=$CI_PROJECT_URL \
      --export-cache type=inline \
      --import-cache type=registry,ref=$LATEST_APP_IMAGE \
      --output type=image,\"name=$CURRENT_APP_IMAGE,$LATEST_APP_IMAGE\",push=true
  only:
    - merge_request
    - master
    - tags

build_mock:
  stage: .pre
  extends: .buildkit_runner
  script: |
    buildctl-daemonless.sh build \
      --frontend=dockerfile.v0 \
      --local context=spec/gitlab_mock \
      --local dockerfile=spec/gitlab_mock \
      --export-cache type=inline \
      --import-cache type=registry,ref=$LATEST_GITLAB_MOCK_IMAGE \
      --output type=image,\"name=$CURRENT_GITLAB_MOCK_IMAGE,$LATEST_GITLAB_MOCK_IMAGE\",push=true
  only:
    - merge_request
    - master
    - tags

# ======================================================================================================================
# Static analysis stage
# ======================================================================================================================
rubocop:
  extends: .ruby_runner
  stage: static analysis
  script:
    - bundle exec rubocop --parallel --color
  only:
    - merge_request
    - master
    - tags

reek:
  extends: .ruby_runner
  stage: static analysis
  script:
    - bundle exec reek --color --progress --force-exclusion --sort-by smelliness .
  only:
    - merge_request
    - master
    - tags

brakeman:
  extends: .ruby_runner
  stage: static analysis
  script:
    - bundle exec brakeman --color
  only:
    - merge_request
    - master
    - tags

# ======================================================================================================================
# Test Stage
# ======================================================================================================================
unit_tests:
  extends: .ruby_runner
  stage: test
  variables:
    COVERAGE: "true"
    NO_COLOR: "1"
  script:
    - bundle exec rspec --format documentation --format RspecJunitFormatter --out tmp/rspec.xml
  coverage: /COVERAGE:\s+(\d+.\d+)\%/
  artifacts:
    reports:
      cobertura: coverage/coverage.xml
      junit: tmp/rspec.xml
  only:
    - merge_request
    - master
    - tags

e2e_test:
  image:
    name: $CURRENT_APP_IMAGE
    entrypoint: [""]
  stage: test
  services:
    - name: $CURRENT_GITLAB_MOCK_IMAGE
      alias: gitlab
  variables:
    SETTINGS__GITLAB_ACCESS_TOKEN: e2e-test
    SETTINGS__GITLAB_URL: http://gitlab:4567
    RAILS_ENV: production
    GIT_STRATEGY: none
  script:
    - cd /home/dependabot
    - bundle exec rake 'dependabot:update[test-repo,bundler]'
  only:
    - merge_request
    - master
    - tags

# ======================================================================================================================
# Release Stage
# ======================================================================================================================
release:
  extends: .docker_runner
  stage: release
  variables:
    RELEASE_IMAGE: docker.io/andrcuns/dependabot-gitlab
    RELEASE_VERSION: $RELEASE_IMAGE:$CI_COMMIT_TAG
    LATEST_VERSION: $RELEASE_IMAGE:latest
  script:
    - docker pull $CURRENT_APP_IMAGE
    - docker tag $CURRENT_APP_IMAGE $RELEASE_VERSION
    - docker tag $CURRENT_APP_IMAGE $LATEST_VERSION
    - docker push $RELEASE_VERSION && docker push $LATEST_VERSION
  only:
    - tags

# ======================================================================================================================
# Deploy Stage
# ======================================================================================================================
deploy:
  extends: .heroku_runner
  stage: deploy
  script:
    - git push heroku master
  environment:
    name: heroku
    url: https://dependabot-gitlab.herokuapp.com/
  only:
    refs:
      - master
    changes:
      - app/**/*
      - config/**/*
      - lib/**/*
      - public/**/*
      - bin/rails
      - config.ru
      - Gemfile
      - Gemfile.lock
      - Rakefile
      - Dockerfile
      - .dockerignore
