.mr: &mr
  if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_PROJECT_NAMESPACE == "dependabot-gitlab"'
.mr_forked: &mr_forked
  if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_PROJECT_NAMESPACE !~ /dependabot-gitlab/'
.master: &master
  if: '$CI_COMMIT_BRANCH == "master"'
.release: &release
  if: '$CI_COMMIT_TAG =~ /^v[0-9.]+$/'

.main: &main
  - *mr
  - *master
  - *release
.fork: &fork
  - *mr_forked

# ======================================================================================================================
# Global
# ======================================================================================================================
stages:
  - static analysis
  - test
  - release
  - deploy

variables:
  APP_DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  GITLAB_MOCK_DOCKER_IMAGE: $CI_REGISTRY_IMAGE/gitlab-mock
  CURRENT_TAG: $CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
  LATEST_TAG: $CI_COMMIT_REF_SLUG-latest
  CODACY_VERSION: "11.2.3"

include:
  - local: .gitlab/ci/jobs.gitlab-ci.yml

# ======================================================================================================================
# Pre Stage
# ======================================================================================================================
cache_dependencies:
  extends: .cache_dependencies
  tags:
    - private
  rules: *main
cache_dependencies_fork:
  extends: .cache_dependencies
  rules: *fork

build_app_image:
  extends: .build_app_image
  tags:
    - private
  rules: *main
build_app_image_fork:
  extends: .build_app_image
  tags:
    - docker
  variables:
    FORK: "true"
  rules: *fork

build_mock_image:
  extends: .build_mock_image
  tags:
    - private
  rules: *main
build_mock_image_fork:
  extends: .build_mock_image
  tags:
    - docker
  variables:
    FORK: "true"
  rules: *fork

# ======================================================================================================================
# Static analysis stage
# ======================================================================================================================
rubocop:
  extends: .rubocop
  tags:
    - private
  rules: *main
rubocop_fork:
  extends: .rubocop
  rules: *fork

reek:
  extends: .reek
  tags:
    - private
  rules: *main
reek_fork:
  extends: .reek
  rules: *fork

brakeman:
  extends: .brakeman
  tags:
    - private
  rules: *main
brakeman_fork:
  extends: .brakeman
  rules: *fork

bundle_audit:
  extends: .bundle_audit
  tags:
    - private
  rules: *main
bundle_audit_fork:
  extends: .bundle_audit
  tags:
    - private
  rules: *fork

# ======================================================================================================================
# Test Stage
# ======================================================================================================================
tests_rspec:
  extends: .tests_rspec
  tags:
    - private
  rules: *main
tests_rspec_fork:
  extends: .tests_rspec
  rules: *fork

tests_standalone_version:
  extends: .tests_standalone_version
  tags:
    - private
  variables:
    SETTINGS__GITHUB_ACCESS_TOKEN: $GITHUB_ACCESS_TOKEN
  rules: *main
tests_standalone_version_fork:
  extends: .tests_standalone_version
  rules: *fork

# ======================================================================================================================
# Release Stage
# ======================================================================================================================
release_image:
  stage: release
  extends: .release_runner
  tags:
    - private
  variables:
    RELEASE_IMAGE: docker.io/andrcuns/dependabot-gitlab
  script:
    - |
      apk -qq update && apk -qq add grep
      export RELEASE_VERSION=$(echo $CI_COMMIT_TAG | grep -oP 'v\K[0-9.]+')
    - |
      docker pull $APP_DOCKER_IMAGE:$CURRENT_TAG
      docker tag $APP_DOCKER_IMAGE:$CURRENT_TAG $RELEASE_IMAGE:$RELEASE_VERSION
      docker tag $APP_DOCKER_IMAGE:$CURRENT_TAG $RELEASE_IMAGE:latest
      docker push $RELEASE_IMAGE:$RELEASE_VERSION && docker push $RELEASE_IMAGE:latest
  rules:
    - *release

create_gitlab_release:
  stage: release
  extends: .ruby_runner
  variables:
    SETTINGS__GITLAB_ACCESS_TOKEN: $GITLAB_ACCESS_TOKEN
  tags:
    - private
  script:
    - bundle exec rake "dependabot:gitlab_release[$CI_COMMIT_TAG]"
  rules:
    - *release

# ======================================================================================================================
# Deploy Stage
# ======================================================================================================================
deploy:
  stage: deploy
  extends: .deploy_runner
  tags:
    - private
  environment:
    name: production
    url: $DEPENDABOT_URL
  script:
    - helmfile repos
    - helmfile apply --suppress-secrets --context 10
  rules:
    - *master
    - <<: *mr
      when: manual
      allow_failure: true
