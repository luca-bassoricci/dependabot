# frozen_string_literal: true

class SecurityVulnerabilityUpdateJob < ApplicationJob
  using Rainbow

  queue_as :vulnerability_update

  sidekiq_options retry: 2, dead: false

  # Run update for local copy of Github security advisory database
  #
  # @return [void]
  def perform
    run_within_context("vulnerability-db-update") do
      log(:info, "Running local security vulnerability database update")
      Github::Vulnerabilities::Fetcher::PACKAGE_ECOSYSTEMS.each_key do |package_ecosystem|
        log(:info, "Updating local advisory database for #{package_ecosystem.bright} package ecosystem")
        vulnerabilities = Github::Vulnerabilities::Fetcher.call(package_ecosystem) do |nodes|
          update_vulnerabilities(nodes, package_ecosystem)
        end
        log(:info, "Saved information for #{vulnerabilities.size.to_s.bright} security vulnerabilities")
      rescue StandardError => e
        log_error(e)
      end
      log(:info, "Finished local security vulnerability database update")
    end
  end

  private

  # Update or save vulnerabilities
  #
  # @param [Array] nodes
  # @param [String] package_ecosystem
  # @return [void]
  def update_vulnerabilities(nodes, package_ecosystem)
    log(:debug, "Saving vulnerability info to local database")
    nodes.each do |node|
      advisory = node.advisory

      vulnerability = Vulnerability.find_or_initialize_by(
        id: advisory.database_id,
        identifiers: advisory.identifiers.map(&:value),
        package: node.package.name,
        package_ecosystem: package_ecosystem,
        package_manager: Dependabot::Ecosystem::PACKAGE_ECOSYSTEM_MAPPING.fetch(package_ecosystem, package_ecosystem),
        vulnerable_version_range: node.vulnerable_version_range
      )

      vulnerability.update_attributes!(
        severity: node.severity,
        summary: advisory.summary,
        description: advisory.description,
        permalink: advisory.permalink,
        origin: advisory.origin,
        references: advisory.references.map(&:url),
        first_patched_version: node.first_patched_version&.identifier,
        published_at: advisory.published_at,
        withdrawn_at: advisory.withdrawn_at
      )
    end
  end
end
